import discord
from discord.ext import commands
from PIL import Image, ImageDraw, ImageFont, ImageOps
import requests
from io import BytesIO

# Discord 봇 설정
intents = discord.Intents.default()
intents.message_content = True  # 유저 메시지 내용 접근 가능
intents.members = True  # 유저 정보 접근 가능
bot = commands.Bot(command_prefix="!", intents=intents)

FONT_PATH = "C:\\Users\\USER1\\Downloads\\DiscordBot\\saves\\LINESeedKR-Bd.ttf"
BACKGROUND_PATH = "C:\\Users\\USER1\\Downloads\\DiscordBot\\saves\\배경.png"

@bot.slash_command(guild_ids=[1272185394162831421], name="text_to_image", description="Generate an image with your text")
async def text_to_image(ctx, text: str):
    # 유저 정보 가져오기
    user = ctx.author
    username = user.name
    user_id = user.id
    
    # 유저 프로필 사진 가져오기
    avatar_url = user.avatar.url
    response = requests.get(avatar_url)
    avatar_img = Image.open(BytesIO(response.content)).convert("RGBA")
    avatar_img = avatar_img.resize((100, 100))  # 프로필 사진 크기 조정

    mask = Image.new("L", avatar_img.size, 0)
    draw_mask = ImageDraw.Draw(mask)
    draw_mask.ellipse((0, 0, 100, 100), fill=255)  # 원형 마스크 그리기

    # 마스크를 적용하여 원형 이미지 만들기
    avatar_img = ImageOps.fit(avatar_img, (100, 100), Image.LANCZOS)
    avatar_img.putalpha(mask)  # 마스크를 적용하여 알파 채널로 변환
    
    # 배경 이미지 불러오기
    background = Image.open(BACKGROUND_PATH).convert("RGB")
    draw = ImageDraw.Draw(background)
    
    # 글꼴 설정
    try:
        font_large = ImageFont.truetype(FONT_PATH, 50)  # 큰 글씨 (상단)
        font_small = ImageFont.truetype(FONT_PATH, 30)  # 작은 글씨 (유저 정보)
    except IOError:
        font_large = ImageFont.load_default()
        font_small = ImageFont.load_default()

    # 상단 텍스트 추가 (HYPER BC SAVE)
    draw.text((50, 20), "환영합니다!", font=font_large, fill=(255, 255, 255))

    # 유저 정보 텍스트 추가 (이름, ID)
    draw.text((170, 120), f"Name: {username}", font=font_small, fill=(255, 255, 255))
    draw.text((170, 160), f"ID: {user_id}", font=font_small, fill=(255, 255, 255))
    
    # 유저 입력 텍스트 추가
    draw.text((50, 300), text, font=font_small, fill=(255, 255, 255))
    
    # 프로필 사진 추가
    background.paste(avatar_img, (50, 100), avatar_img)  # 좌표 (50, 100)에 프로필 사진 추가
    
    # 이미지 파일로 저장
    image_path = "output_image.png"
    background.save(image_path)

    # 이미지 Discord로 전송
    with open(image_path, "rb") as file:
        await ctx.respond(file=discord.File(file, "output_image.png"))

@bot.event
async def on_ready():
    print(f'봇이 로그인되었습니다. {bot.user}')

# Discord 봇 실행 (토큰 필요)
bot.run("YOUR_TOKEN")
